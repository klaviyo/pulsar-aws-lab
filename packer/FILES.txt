Pulsar Base AMI - Packer Templates
===================================

Directory Structure:
-------------------
packer/
├── pulsar-base.pkr.hcl              # Main Packer template
├── variables.pkrvars.hcl            # Variable definitions (optional)
├── build.sh                          # Convenience build script
├── Makefile                          # Make targets for common operations
├── README.md                         # Complete documentation
├── QUICK_START.md                    # Quick start guide
├── .gitignore                        # Git ignore patterns
├── scripts/
│   ├── configure-system.sh          # System configuration and optimization
│   ├── install-pulsar.sh            # Apache Pulsar installation
│   └── install-benchmark.sh         # OpenMessaging Benchmark setup
└── files/
    └── systemd/
        ├── zookeeper.service.tpl    # ZooKeeper systemd template
        ├── bookkeeper.service.tpl   # BookKeeper systemd template
        └── broker.service.tpl       # Broker systemd template

Key Files:
----------

1. pulsar-base.pkr.hcl
   - HCL2 Packer template
   - Builds on Amazon Linux 2023
   - Parameterized for region, Pulsar version, instance type
   - Includes validation and cleanup steps

2. scripts/configure-system.sh
   - Installs system utilities (wget, tar, vim, htop, jq, nmap-ncat, etc.)
   - Installs Java 17 (Amazon Corretto) - LTS version with better performance
   - Disables SELinux, sets timezone to UTC
   - Configures system limits (file descriptors, processes)
   - Sets up sysctl tuning for network performance
   - Creates base directories

3. scripts/install-pulsar.sh
   - Downloads Apache Pulsar from archive.apache.org
   - Extracts to /opt/pulsar
   - Creates symlinks to /usr/local/bin
   - Verifies installation

4. scripts/install-benchmark.sh
   - Installs Maven
   - Clones OpenMessaging Benchmark repository
   - Builds benchmark framework (skips tests)
   - Creates helper scripts (run-benchmark, benchmark-info)
   - Sets up benchmark directories

5. files/systemd/*.service.tpl
   - Generic systemd service templates
   - Customized at runtime by Terraform user-data scripts
   - Include proper resource limits and restart policies
   - Stored in /opt/pulsar-templates/systemd/ on AMI

6. build.sh
   - Wrapper script for Packer builds
   - Validates prerequisites
   - Supports custom variables
   - Provides colored output and error checking

7. Makefile
   - Common operations: init, validate, build, clean
   - Support for custom variables
   - AMI listing and deletion helpers

Usage:
------

Quick Start:
  cd packer
  ./build.sh

With Custom Options:
  ./build.sh --region us-east-1 --version 3.1.0

Using Make:
  make build
  make build REGION=us-east-1 PULSAR_VERSION=3.1.0

Using Packer Directly:
  packer init pulsar-base.pkr.hcl
  packer build pulsar-base.pkr.hcl

What Gets Installed:
--------------------
- Amazon Linux 2023 (latest)
- Java 11 (Amazon Corretto)
- Apache Pulsar 3.0.0 in /opt/pulsar
- OpenMessaging Benchmark in /opt/openmessaging-benchmark
- System tools: wget, tar, vim, htop, sysstat, net-tools, nmap-ncat, git, maven
- Optimized system configuration (limits, sysctl)
- Systemd service templates in /opt/pulsar-templates/systemd/

Benefits:
---------
- Faster deployments (2-3 min vs 15-20 min - no need to download/install Pulsar)
- Consistent base across all instances
- Immutable infrastructure (no configuration drift)
- Version-tagged AMIs for reproducibility
- Cost savings (faster instance startup)
- Simplified deployment (no runtime configuration management)

Next Steps:
-----------
1. Build the AMI: `python scripts/build-ami.py build --version 3.0.0`
2. Validate AMI: `python scripts/build-ami.py validate --ami-id <ami-id>`
3. Deploy with orchestrator: `python scripts/orchestrator.py full --test-plan config/test-plans/poc.yaml`
4. Create AMI versioning strategy for different Pulsar releases
5. Set up automated AMI builds in CI/CD
